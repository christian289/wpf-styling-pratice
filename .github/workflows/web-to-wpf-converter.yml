name: Web to WPF Converter

on:
  schedule:
    # Run 5 times per day at KST: 03:00, 07:00, 11:00, 15:00, 19:00
    # 하루 5번 KST 기준 실행: 03:00, 07:00, 11:00, 15:00, 19:00
    # UTC: 18:00, 22:00, 02:00, 06:00, 10:00
    - cron: '0 18 * * *'
    - cron: '0 22 * * *'
    - cron: '0 2 * * *'
    - cron: '0 6 * * *'
    - cron: '0 10 * * *'
  workflow_dispatch:
    # Allow manual trigger
    # 수동 실행 허용
    inputs:
      skip_download:
        description: 'Skip download step (use existing source)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  pull-requests: write

env:
  # Add paths for Node.js, npm global, dotnet, git
  # Node.js, npm 전역, dotnet, git 경로 추가
  PATH_ADDITIONS: C:\Program Files\nodejs;C:\Users\vincent\AppData\Roaming\npm;C:\Program Files\dotnet;C:\Program Files\Git\cmd

jobs:
  convert:
    # Self-hosted runner on your local Windows PC
    # 로컬 Windows PC에서 실행되는 Self-hosted runner
    runs-on: self-hosted
    timeout-minutes: 60

    defaults:
      run:
        shell: pwsh

    steps:
      - name: Setup PATH environment
        run: |
          $newPath = "${{ env.PATH_ADDITIONS }};$env:PATH"
          echo "PATH=$newPath" >> $env:GITHUB_ENV
          Write-Host "PATH updated with required tools"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify Node.js installation
        run: |
          Write-Host "Node.js version:"
          node --version
          Write-Host "npm version:"
          npm --version

      - name: Verify Claude Code installation
        run: |
          Write-Host "Claude Code version:"
          claude --version

      - name: Install script dependencies
        working-directory: scripts
        run: npm install

      - name: Download random UI component from uiverse.io
        if: ${{ github.event.inputs.skip_download != 'true' }}
        working-directory: scripts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: node download-component.js

      - name: Extract HTML and CSS
        working-directory: scripts
        run: node extract-html-css.js

      - name: Read component info
        id: component
        run: |
          $json = Get-Content "WebToDesktop/source/latest-download.json" | ConvertFrom-Json
          "control_name=$($json.controlName)" >> $env:GITHUB_OUTPUT
          "html_path=$($json.htmlPath)" >> $env:GITHUB_OUTPUT
          "css_path=$($json.cssPath)" >> $env:GITHUB_OUTPUT
          "category=$($json.category)" >> $env:GITHUB_OUTPUT

      - name: Convert to WPF using Claude Code CLI
        working-directory: WebToDesktop
        run: |
          $CONTROL_NAME = "${{ steps.component.outputs.control_name }}"
          $HTML_PATH = "${{ steps.component.outputs.html_path }}"
          $CSS_PATH = "${{ steps.component.outputs.css_path }}"
          $TODAY = Get-Date -Format "yyyyMMdd"

          Write-Host "=== Starting WPF Conversion ==="
          Write-Host "Control: $CONTROL_NAME"
          Write-Host "HTML: $HTML_PATH"
          Write-Host "CSS: $CSS_PATH"

          # Run Claude Code CLI with the wpf-custom-control command
          # Claude Code CLI로 wpf-custom-control 커맨드 실행
          $prompt = @"
          /wpf-custom-control $CONTROL_NAME "$HTML_PATH" "$CSS_PATH"

          변환 후 작업:
          1. dotnet build 명령으로 빌드 확인
          2. 컴파일 에러가 있으면 수정
          3. 에러 수정 내용을 Log/${CONTROL_NAME}_${TODAY}.md 파일에 기록
             - 에러 내용
             - 수정 방법
             - runtime error 가능성 (직접 확인 필요)

          중요:
          - compile error만 해결하고, runtime error는 잠재적 오류로 기록만 합니다
          - 변환 과정에서 html-css-to-wpf-xaml skill의 가이드를 참고하세요
          "@

          claude -p $prompt --allowedTools "Bash,Read,Write,Edit,Glob,Grep" --max-turns 50 --dangerously-skip-permissions

      - name: Check for changes
        id: changes
        run: |
          git add -A
          git diff --staged --quiet
          if ($LASTEXITCODE -ne 0) {
            "has_changes=true" >> $env:GITHUB_OUTPUT
            Write-Host "Changes detected"
          } else {
            "has_changes=false" >> $env:GITHUB_OUTPUT
            Write-Host "No changes"
          }
          exit 0

      - name: Commit and Push
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A

          $TIMESTAMP = Get-Date -Format "yyyy-MM-dd_HHmm"
          $CONTROL_NAME = "${{ steps.component.outputs.control_name }}"
          $CATEGORY = "${{ steps.component.outputs.category }}"

          $commitMessage = @"
          Auto: Convert $CONTROL_NAME from uiverse.io ($CATEGORY)

          - Source: uiverse-io/galaxy
          - Category: $CATEGORY
          - Control: $CONTROL_NAME
          - Converted at: $TIMESTAMP

          Generated with Claude Code (https://claude.com/claude-code)

          Co-Authored-By: Claude <noreply@anthropic.com>
          "@

          git commit -m $commitMessage
          git push

      - name: Summary
        run: |
          "## Conversion Summary" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          "- **Control Name**: ${{ steps.component.outputs.control_name }}" >> $env:GITHUB_STEP_SUMMARY
          "- **Category**: ${{ steps.component.outputs.category }}" >> $env:GITHUB_STEP_SUMMARY
          "- **Source**: uiverse-io/galaxy" >> $env:GITHUB_STEP_SUMMARY
          $status = if ("${{ steps.changes.outputs.has_changes }}" -eq "true") { "Converted and committed" } else { "No changes" }
          "- **Status**: $status" >> $env:GITHUB_STEP_SUMMARY
