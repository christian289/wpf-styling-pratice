name: Web to Desktop Converter

on:
  schedule:
    # Run 5 times per day at KST: 03:00, 07:00, 11:00, 15:00, 19:00
    # 하루 5번 KST 기준 실행: 03:00, 07:00, 11:00, 15:00, 19:00
    # UTC: 18:00, 22:00, 02:00, 06:00, 10:00
    - cron: '0 18 * * *'
    - cron: '0 22 * * *'
    - cron: '0 2 * * *'
    - cron: '0 6 * * *'
    - cron: '0 10 * * *'
  workflow_dispatch:
    # Allow manual trigger
    # 수동 실행 허용
    inputs:
      skip_download:
        description: 'Skip download step (use existing source)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  pull-requests: write

env:
  # Add paths for Node.js, npm global, dotnet, git
  # Node.js, npm 전역, dotnet, git 경로 추가
  PATH_ADDITIONS: C:\Program Files\nodejs;C:\Users\vincent\AppData\Roaming\npm;C:\Program Files\dotnet;C:\Program Files\Git\cmd

jobs:
  convert:
    # Self-hosted runner on your local Windows PC
    # 로컬 Windows PC에서 실행되는 Self-hosted runner
    runs-on: self-hosted
    timeout-minutes: 60

    defaults:
      run:
        shell: pwsh

    steps:
      - name: Setup PATH environment
        run: |
          $newPath = "${{ env.PATH_ADDITIONS }};$env:PATH"
          echo "PATH=$newPath" >> $env:GITHUB_ENV
          Write-Host "PATH updated with required tools"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify Node.js installation
        run: |
          Write-Host "Node.js version:"
          node --version
          Write-Host "npm version:"
          npm --version

      - name: Verify Claude Code installation
        run: |
          Write-Host "Claude Code version:"
          claude --version

      - name: Install script dependencies
        working-directory: scripts
        run: npm install

      - name: Download random UI component from uiverse.io
        if: ${{ github.event.inputs.skip_download != 'true' }}
        working-directory: scripts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: node download-component.js

      - name: Extract HTML and CSS
        working-directory: scripts
        run: node extract-html-css.js

      - name: Read component info
        id: component
        run: |
          $json = Get-Content "WebToDesktop/source/latest-download.json" | ConvertFrom-Json
          "control_name=$($json.controlName)" >> $env:GITHUB_OUTPUT
          "html_path=$($json.htmlPath)" >> $env:GITHUB_OUTPUT
          "css_path=$($json.cssPath)" >> $env:GITHUB_OUTPUT
          "category=$($json.category)" >> $env:GITHUB_OUTPUT
          "component_dir=$($json.componentDir)" >> $env:GITHUB_OUTPUT

          # Read metadata.json to get originalFilename for uiverse.io URL
          # uiverse.io URL 생성을 위해 metadata.json에서 originalFilename 읽기
          $metadataPath = Join-Path $json.componentDir "metadata.json"
          $metadata = Get-Content $metadataPath | ConvertFrom-Json
          $originalFilename = $metadata.originalFilename

          # Parse originalFilename: "username_element-id.html" -> username, element-id
          # originalFilename 파싱: "username_element-id.html" -> username, element-id
          $baseName = [System.IO.Path]::GetFileNameWithoutExtension($originalFilename)
          $parts = $baseName -split '_', 2
          $username = $parts[0]
          $elementId = $parts[1]
          $uiverseUrl = "https://uiverse.io/$username/$elementId"

          "original_filename=$originalFilename" >> $env:GITHUB_OUTPUT
          "author=$username" >> $env:GITHUB_OUTPUT
          "uiverse_url=$uiverseUrl" >> $env:GITHUB_OUTPUT

          Write-Host "Uiverse URL: $uiverseUrl"

      - name: Create control folder structure
        run: |
          $CONTROL_NAME = "${{ steps.component.outputs.control_name }}"
          $CONTROL_DIR = "WebToDesktop/Output/$CONTROL_NAME"
          $WPF_DIR = "$CONTROL_DIR/Wpf"
          $AVALONIA_DIR = "$CONTROL_DIR/AvaloniaUI"

          # Create folder structure: WebToDesktop/Output/{ControlName}/Wpf/ and AvaloniaUI/
          # 폴더 구조 생성: WebToDesktop/Output/{ControlName}/Wpf/ 및 AvaloniaUI/
          New-Item -ItemType Directory -Force -Path $WPF_DIR
          New-Item -ItemType Directory -Force -Path $AVALONIA_DIR
          Write-Host "Created folder structure: $WPF_DIR"
          Write-Host "Created folder structure: $AVALONIA_DIR"

          # Save paths for later steps
          # 이후 단계를 위해 경로 저장
          "control_dir=$CONTROL_DIR" >> $env:GITHUB_OUTPUT
          "wpf_dir=$WPF_DIR" >> $env:GITHUB_OUTPUT
          "avalonia_dir=$AVALONIA_DIR" >> $env:GITHUB_OUTPUT
        id: folders

      - name: Convert to WPF using Claude Code CLI
        working-directory: ${{ steps.folders.outputs.wpf_dir }}
        run: |
          $CONTROL_NAME = "${{ steps.component.outputs.control_name }}"
          $HTML_PATH = "${{ steps.component.outputs.html_path }}"
          $CSS_PATH = "${{ steps.component.outputs.css_path }}"
          $CATEGORY = "${{ steps.component.outputs.category }}"
          $AUTHOR = "${{ steps.component.outputs.author }}"
          $UIVERSE_URL = "${{ steps.component.outputs.uiverse_url }}"
          $TODAY = Get-Date -Format "yyyyMMdd"
          $CONTROL_DIR = "${{ steps.folders.outputs.control_dir }}"

          Write-Host "=== Starting WPF Conversion ==="
          Write-Host "Control: $CONTROL_NAME"
          Write-Host "HTML: $HTML_PATH"
          Write-Host "CSS: $CSS_PATH"
          Write-Host "Author: $AUTHOR"
          Write-Host "Uiverse URL: $UIVERSE_URL"
          Write-Host "Output Dir: $CONTROL_DIR"

          # Run Claude Code CLI with the wpf-custom-control command
          # Claude Code CLI로 wpf-custom-control 커맨드 실행
          $prompt = @"
          /wpf-custom-control $CONTROL_NAME "$HTML_PATH" "$CSS_PATH"

          중요한 폴더 구조:
          - 현재 작업 디렉토리는 WebToDesktop/Output/$CONTROL_NAME/Wpf/ 입니다
          - .slnx 파일과 프로젝트 폴더는 현재 디렉토리에 생성하세요
          - 예: ${CONTROL_NAME}.Wpf.slnx, ${CONTROL_NAME}.Wpf.Gallery/, ${CONTROL_NAME}.Wpf.UI/

          변환 후 작업:
          1. dotnet build 명령으로 빌드 확인
          2. 컴파일 에러가 있으면 수정
          3. 에러 수정 내용을 ../../../Log/${CONTROL_NAME}_${TODAY}.md 파일에 기록
             - 에러 내용
             - 수정 방법
             - runtime error 가능성 (직접 확인 필요)

          4. 변환 완료 후 상위 폴더에 Readme.md 생성 (../Readme.md):
             - 제목: # $CONTROL_NAME
             - 설명: $CATEGORY 스타일 컨트롤
             - 원본 정보:
               - 원작자: $AUTHOR
               - 원본 링크: [$UIVERSE_URL]($UIVERSE_URL) (클릭 시 원본 CSS/HTML 확인 가능)
             - 빌드 명령 (WPF): cd Wpf && dotnet run --project ${CONTROL_NAME}.Wpf.Gallery
             - 빌드 명령 (AvaloniaUI): cd AvaloniaUI && dotnet run --project ${CONTROL_NAME}.Avalonia.Gallery
             - CSS → WPF 변환 매핑 테이블

          중요:
          - compile error만 해결하고, runtime error는 잠재적 오류로 기록만 합니다
          - 변환 과정에서 html-css-to-wpf-xaml skill의 가이드를 참고하세요
          "@

          claude -p $prompt --allowedTools "Bash,Read,Write,Edit,Glob,Grep" --max-turns 50 --dangerously-skip-permissions

      - name: Convert to AvaloniaUI using Claude Code CLI
        working-directory: ${{ steps.folders.outputs.avalonia_dir }}
        run: |
          $CONTROL_NAME = "${{ steps.component.outputs.control_name }}"
          $CATEGORY = "${{ steps.component.outputs.category }}"
          $TODAY = Get-Date -Format "yyyyMMdd"
          $WPF_DIR = "${{ steps.folders.outputs.wpf_dir }}"
          $CONTROL_DIR = "${{ steps.folders.outputs.control_dir }}"

          Write-Host "=== Starting AvaloniaUI Conversion ==="
          Write-Host "Control: $CONTROL_NAME"
          Write-Host "Reference WPF Project: $WPF_DIR"
          Write-Host "Output Dir: $CONTROL_DIR/AvaloniaUI"

          # Run Claude Code CLI to create AvaloniaUI project based on WPF project
          # Claude Code CLI로 WPF 프로젝트를 참고하여 AvaloniaUI 프로젝트 생성
          $prompt = @"
          WPF 프로젝트를 참고하여 동일한 구조의 AvaloniaUI 프로젝트를 생성해주세요.

          참고할 WPF 프로젝트 경로: $WPF_DIR

          생성할 AvaloniaUI 프로젝트 구조:
          - 현재 작업 디렉토리: WebToDesktop/Output/$CONTROL_NAME/AvaloniaUI/
          - ${CONTROL_NAME}.Avalonia.slnx (솔루션 파일)
          - ${CONTROL_NAME}.Avalonia.UI/ (커스텀 컨트롤 라이브러리)
            - Controls/${CONTROL_NAME}.cs
            - Themes/Generic.axaml (ResourceDictionary 병합)
            - Themes/${CONTROL_NAME}.axaml (실제 스타일)
          - ${CONTROL_NAME}.Avalonia.Gallery/ (데모 애플리케이션)
            - App.axaml
            - MainWindow.axaml

          변환 시 주의사항:
          1. WPF의 .xaml 파일은 AvaloniaUI의 .axaml로 변환
          2. WPF의 pack:// URI는 avares:// URI로 변환
          3. ResourceDictionary.MergedDictionaries의 Source 형식 변환:
             - WPF: Source="/라이브러리;component/Themes/파일.xaml"
             - Avalonia: Source="avares://라이브러리/Themes/파일.axaml"
          4. DropShadowEffect → BoxShadow 변환
          5. WPF 전용 속성(UseLayoutRounding 등) 제거 또는 대체
          6. xmlns 네임스페이스 변환
          7. TargetFramework는 net9.0 사용 (net9.0-windows 아님)
          8. wpf-to-avaloniaui-radialgradientbrush skill을 참고하여 RadialGradientBrush 변환 시 주의

          변환 후 작업:
          1. dotnet build 명령으로 빌드 확인
          2. 컴파일 에러가 있으면 수정
          3. 에러 수정 내용을 ../../../Log/${CONTROL_NAME}_Avalonia_${TODAY}.md 파일에 기록

          중요:
          - compile error만 해결하고, runtime error는 잠재적 오류로 기록만 합니다
          "@

          claude -p $prompt --allowedTools "Bash,Read,Write,Edit,Glob,Grep" --max-turns 50 --dangerously-skip-permissions

      - name: Check for changes
        id: changes
        run: |
          git add -A
          git diff --staged --quiet
          if ($LASTEXITCODE -ne 0) {
            "has_changes=true" >> $env:GITHUB_OUTPUT
            Write-Host "Changes detected"
          } else {
            "has_changes=false" >> $env:GITHUB_OUTPUT
            Write-Host "No changes"
          }
          exit 0

      - name: Commit and Push
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A

          $TIMESTAMP = Get-Date -Format "yyyy-MM-dd_HHmm"
          $CONTROL_NAME = "${{ steps.component.outputs.control_name }}"
          $CATEGORY = "${{ steps.component.outputs.category }}"

          $AUTHOR = "${{ steps.component.outputs.author }}"
          $UIVERSE_URL = "${{ steps.component.outputs.uiverse_url }}"

          $commitMessage = @"
          Auto: Convert $CONTROL_NAME from uiverse.io ($CATEGORY)

          - Source: $UIVERSE_URL
          - Author: $AUTHOR
          - Category: $CATEGORY
          - Control: $CONTROL_NAME
          - Targets: WPF, AvaloniaUI
          - Converted at: $TIMESTAMP

          Generated with Claude Code (https://claude.com/claude-code)

          Co-Authored-By: Claude <noreply@anthropic.com>
          "@

          git commit -m $commitMessage
          git push

      - name: Summary
        run: |
          "## Conversion Summary" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          "- **Control Name**: ${{ steps.component.outputs.control_name }}" >> $env:GITHUB_STEP_SUMMARY
          "- **Category**: ${{ steps.component.outputs.category }}" >> $env:GITHUB_STEP_SUMMARY
          "- **Author**: ${{ steps.component.outputs.author }}" >> $env:GITHUB_STEP_SUMMARY
          "- **Source**: [${{ steps.component.outputs.uiverse_url }}](${{ steps.component.outputs.uiverse_url }})" >> $env:GITHUB_STEP_SUMMARY
          "- **Targets**: WPF, AvaloniaUI" >> $env:GITHUB_STEP_SUMMARY
          $status = if ("${{ steps.changes.outputs.has_changes }}" -eq "true") { "Converted and committed" } else { "No changes" }
          "- **Status**: $status" >> $env:GITHUB_STEP_SUMMARY
