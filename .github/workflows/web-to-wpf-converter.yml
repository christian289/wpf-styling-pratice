name: Web to WPF Converter

on:
  schedule:
    # Run 5 times per day at KST: 03:00, 07:00, 11:00, 15:00, 19:00
    # í•˜ë£¨ 5ë²ˆ KST ê¸°ì¤€ ì‹¤í–‰: 03:00, 07:00, 11:00, 15:00, 19:00
    # UTC: 18:00, 22:00, 02:00, 06:00, 10:00
    - cron: '0 18 * * *'
    - cron: '0 22 * * *'
    - cron: '0 2 * * *'
    - cron: '0 6 * * *'
    - cron: '0 10 * * *'
  workflow_dispatch:
    # Allow manual trigger
    # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©
    inputs:
      skip_download:
        description: 'Skip download step (use existing source)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  convert:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install script dependencies
        working-directory: scripts
        run: npm install

      - name: Download random UI component from uiverse.io
        if: ${{ github.event.inputs.skip_download != 'true' }}
        working-directory: scripts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: node download-component.js

      - name: Extract HTML and CSS
        working-directory: scripts
        run: node extract-html-css.js

      - name: Read component info
        id: component
        run: |
          CONTROL_NAME=$(jq -r '.controlName' WebToDesktop/source/latest-download.json)
          HTML_PATH=$(jq -r '.htmlPath' WebToDesktop/source/latest-download.json)
          CSS_PATH=$(jq -r '.cssPath' WebToDesktop/source/latest-download.json)
          CATEGORY=$(jq -r '.category' WebToDesktop/source/latest-download.json)
          echo "control_name=$CONTROL_NAME" >> $GITHUB_OUTPUT
          echo "html_path=$HTML_PATH" >> $GITHUB_OUTPUT
          echo "css_path=$CSS_PATH" >> $GITHUB_OUTPUT
          echo "category=$CATEGORY" >> $GITHUB_OUTPUT

      - name: Change to WebToDesktop directory
        run: cd WebToDesktop

      - name: Convert to WPF using Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            í˜„ìž¬ ë””ë ‰í† ë¦¬ë¥¼ WebToDesktopìœ¼ë¡œ ë³€ê²½í•œ í›„ ìž‘ì—…ì„ ìˆ˜í–‰í•´ì£¼ì„¸ìš”.

            ## ìž‘ì—… ë‚´ìš©
            /wpf-custom-control ${{ steps.component.outputs.control_name }} "${{ steps.component.outputs.html_path }}" "${{ steps.component.outputs.css_path }}"

            ## ë³€í™˜ í›„ ìž‘ì—…
            1. `dotnet build` ëª…ë ¹ìœ¼ë¡œ ë¹Œë“œ í™•ì¸
            2. ì»´íŒŒì¼ ì—ëŸ¬ê°€ ìžˆìœ¼ë©´ ìˆ˜ì •
            3. ì—ëŸ¬ ìˆ˜ì • ë‚´ìš©ì„ WebToDesktop/Log/${{ steps.component.outputs.control_name }}_$(date +%Y%m%d).md íŒŒì¼ì— ê¸°ë¡
               - ì—ëŸ¬ ë‚´ìš©
               - ìˆ˜ì • ë°©ë²•
               - runtime error ê°€ëŠ¥ì„± (ì§ì ‘ í™•ì¸ í•„ìš”)

            ## ì¤‘ìš”
            - compile errorë§Œ í•´ê²°í•˜ê³ , runtime errorëŠ” ìž ìž¬ì  ì˜¤ë¥˜ë¡œ ê¸°ë¡ë§Œ í•©ë‹ˆë‹¤
            - ë³€í™˜ ê³¼ì •ì—ì„œ html-css-to-wpf-xaml skillì˜ ê°€ì´ë“œë¥¼ ì°¸ê³ í•˜ì„¸ìš”
          claude_args: |
            --max-turns 50
            --permission-mode acceptEdits
            --dangerously-skip-permissions
          allowed_tools: |
            Bash
            Read
            Write
            Edit
            Glob
            Grep

      - name: Check for changes
        id: changes
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and Push
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A

          TIMESTAMP=$(date +%Y-%m-%d_%H%M)
          CONTROL_NAME="${{ steps.component.outputs.control_name }}"
          CATEGORY="${{ steps.component.outputs.category }}"

          git commit -m "$(cat <<'EOF'
          Auto: Convert $CONTROL_NAME from uiverse.io ($CATEGORY)

          - Source: uiverse-io/galaxy
          - Category: $CATEGORY
          - Control: $CONTROL_NAME
          - Converted at: $TIMESTAMP

          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
          EOF
          )"

          git push

      - name: Summary
        run: |
          echo "## Conversion Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Control Name**: ${{ steps.component.outputs.control_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Category**: ${{ steps.component.outputs.category }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Source**: uiverse-io/galaxy" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ steps.changes.outputs.has_changes == 'true' && 'Converted and committed' || 'No changes' }}" >> $GITHUB_STEP_SUMMARY
