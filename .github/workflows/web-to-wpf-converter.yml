name: Web to WPF Converter

on:
  schedule:
    # Run 5 times per day at KST: 03:00, 07:00, 11:00, 15:00, 19:00
    # í•˜ë£¨ 5ë²ˆ KST ê¸°ì¤€ ì‹¤í–‰: 03:00, 07:00, 11:00, 15:00, 19:00
    # UTC: 18:00, 22:00, 02:00, 06:00, 10:00
    - cron: '0 18 * * *'
    - cron: '0 22 * * *'
    - cron: '0 2 * * *'
    - cron: '0 6 * * *'
    - cron: '0 10 * * *'
  workflow_dispatch:
    # Allow manual trigger
    # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©
    inputs:
      skip_download:
        description: 'Skip download step (use existing source)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  convert:
    # Self-hosted runner on your local Windows PC
    # ë¡œì»¬ Windows PCì—ì„œ ì‹¤í–‰ë˜ëŠ” Self-hosted runner
    runs-on: self-hosted
    timeout-minutes: 60

    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify Node.js installation
        run: |
          Write-Host "Node.js version:"
          node --version
          Write-Host "npm version:"
          npm --version

      - name: Verify Claude Code installation
        run: |
          Write-Host "Claude Code version:"
          claude --version

      - name: Install script dependencies
        working-directory: scripts
        run: npm install

      - name: Download random UI component from uiverse.io
        if: ${{ github.event.inputs.skip_download != 'true' }}
        working-directory: scripts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: node download-component.js

      - name: Extract HTML and CSS
        working-directory: scripts
        run: node extract-html-css.js

      - name: Read component info
        id: component
        run: |
          $json = Get-Content "WebToDesktop/source/latest-download.json" | ConvertFrom-Json
          "control_name=$($json.controlName)" >> $env:GITHUB_OUTPUT
          "html_path=$($json.htmlPath)" >> $env:GITHUB_OUTPUT
          "css_path=$($json.cssPath)" >> $env:GITHUB_OUTPUT
          "category=$($json.category)" >> $env:GITHUB_OUTPUT

      - name: Convert to WPF using Claude Code CLI
        working-directory: WebToDesktop
        run: |
          $CONTROL_NAME = "${{ steps.component.outputs.control_name }}"
          $HTML_PATH = "${{ steps.component.outputs.html_path }}"
          $CSS_PATH = "${{ steps.component.outputs.css_path }}"
          $TODAY = Get-Date -Format "yyyyMMdd"

          Write-Host "=== Starting WPF Conversion ==="
          Write-Host "Control: $CONTROL_NAME"
          Write-Host "HTML: $HTML_PATH"
          Write-Host "CSS: $CSS_PATH"

          # Run Claude Code CLI with the wpf-custom-control command
          # Claude Code CLIë¡œ wpf-custom-control ì»¤ë§¨ë“œ ì‹¤í–‰
          $prompt = @"
          /wpf-custom-control $CONTROL_NAME "$HTML_PATH" "$CSS_PATH"

          ë³€í™˜ í›„ ìž‘ì—…:
          1. dotnet build ëª…ë ¹ìœ¼ë¡œ ë¹Œë“œ í™•ì¸
          2. ì»´íŒŒì¼ ì—ëŸ¬ê°€ ìžˆìœ¼ë©´ ìˆ˜ì •
          3. ì—ëŸ¬ ìˆ˜ì • ë‚´ìš©ì„ Log/${CONTROL_NAME}_${TODAY}.md íŒŒì¼ì— ê¸°ë¡
             - ì—ëŸ¬ ë‚´ìš©
             - ìˆ˜ì • ë°©ë²•
             - runtime error ê°€ëŠ¥ì„± (ì§ì ‘ í™•ì¸ í•„ìš”)

          ì¤‘ìš”:
          - compile errorë§Œ í•´ê²°í•˜ê³ , runtime errorëŠ” ìž ìž¬ì  ì˜¤ë¥˜ë¡œ ê¸°ë¡ë§Œ í•©ë‹ˆë‹¤
          - ë³€í™˜ ê³¼ì •ì—ì„œ html-css-to-wpf-xaml skillì˜ ê°€ì´ë“œë¥¼ ì°¸ê³ í•˜ì„¸ìš”
          "@

          claude -p $prompt --allowedTools "Bash,Read,Write,Edit,Glob,Grep" --max-turns 50 --dangerously-skip-permissions

      - name: Check for changes
        id: changes
        run: |
          git add -A
          $diff = git diff --staged --quiet; $hasChanges = -not $?
          if ($hasChanges) {
            "has_changes=true" >> $env:GITHUB_OUTPUT
          } else {
            "has_changes=false" >> $env:GITHUB_OUTPUT
          }

      - name: Commit and Push
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A

          $TIMESTAMP = Get-Date -Format "yyyy-MM-dd_HHmm"
          $CONTROL_NAME = "${{ steps.component.outputs.control_name }}"
          $CATEGORY = "${{ steps.component.outputs.category }}"

          $commitMessage = @"
          Auto: Convert $CONTROL_NAME from uiverse.io ($CATEGORY)

          - Source: uiverse-io/galaxy
          - Category: $CATEGORY
          - Control: $CONTROL_NAME
          - Converted at: $TIMESTAMP

          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude <noreply@anthropic.com>
          "@

          git commit -m $commitMessage
          git push

      - name: Summary
        run: |
          "## Conversion Summary" >> $env:GITHUB_STEP_SUMMARY
          "" >> $env:GITHUB_STEP_SUMMARY
          "- **Control Name**: ${{ steps.component.outputs.control_name }}" >> $env:GITHUB_STEP_SUMMARY
          "- **Category**: ${{ steps.component.outputs.category }}" >> $env:GITHUB_STEP_SUMMARY
          "- **Source**: uiverse-io/galaxy" >> $env:GITHUB_STEP_SUMMARY
          $status = if ("${{ steps.changes.outputs.has_changes }}" -eq "true") { "Converted and committed" } else { "No changes" }
          "- **Status**: $status" >> $env:GITHUB_STEP_SUMMARY
